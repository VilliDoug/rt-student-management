<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "./mybatis-3-mapper.dtd">
<mapper namespace="raisetech.student.management.repository.MainRepository">

<!--  受講生の全件検索-->
  <select id="searchAllStudents" resultType="raisetech.student.management.data.Student">
    SELECT * FROM students
  </select>
<!-- select student by ID-->
  <select id="fetchById" resultType="raisetech.student.management.data.Student">
    SELECT * FROM students WHERE id = #{id}
  </select>
<!--  select student by deleted flag=false -->
  <select id="searchNotDeletedStudent" resultType="raisetech.student.management.data.Student">
    SELECT * FROM students WHERE was_deleted = false
  </select>
<!--  select all student courses-->
  <select id="searchAllCourses" resultType="raisetech.student.management.data.Course">
    SELECT * FROM student_courses
  </select>
<!--  select course by studentId -->
  <select id="fetchCourseById" resultType="raisetech.student.management.data.Course">
    SELECT * FROM student_courses WHERE student_id = #{studentId}
  </select>
<!--  register new student -->
  <insert id="registerStudent" parameterType="raisetech.student.management.data.Student"
    useGeneratedKeys="true" keyProperty="id">
    INSERT INTO students (name, kana_name, nickname, email_address, residence, age, gender, remark, was_deleted)
    VALUES (#{name}, #{kanaName}, #{nickname}, #{emailAddress}, #{residence}, #{age}, #{gender}, #{remark}, false)
  </insert>
<!--  register new course - studentId, courseName, courseStartAt, courseEndAt-->
  <insert id="registerCourse" parameterType="raisetech.student.management.data.Course"
    useGeneratedKeys ="true" keyProperty = "id">
    INSERT INTO student_courses (student_id, course_name, course_start_at, course_end_at)
    VALUES (#{studentId}, #{courseName}, #{courseStartAt}, #{courseEndAt})
  </insert>
<!--  update single student by id-->
  <update id="updateStudent" parameterType="raisetech.student.management.data.Student">
    UPDATE students
    SET
      name = #{name},
      kana_name = #{kanaName},
      nickname = #{nickname},
      email_address = #{emailAddress},
      residence = #{residence},
      age = #{age},
      gender = #{gender},
      remark = #{remark},
      was_deleted = #{wasDeleted}
    WHERE id = #{id}
  </update>
<!-- update course name by id-->
  <update id="updateCourseName" parameterType="raisetech.student.management.data.Course">
    UPDATE student_courses
    SET
      course_name = #{courseName}
    WHERE id = #{id}
  </update>
<!--  select all application status-->
  <select id="searchAllStatus" resultType="raisetech.student.management.data.ApplicationStatus">
    SELECT * FROM application_status
  </select>
<!--  select status by course ID-->
  <select id="fetchStatusByCourseIds" resultType="raisetech.student.management.data.ApplicationStatus">
    SELECT * FROM application_status
    WHERE course_id IN
    <foreach item="id" collection="list" open="(" separator="," close=")">
      #{id}
    </foreach>
  </select>
<!--  course by student id-->
  <select id="searchCoursesByStudentId" resultType="raisetech.student.management.data.Course">
    SELECT * FROM student_courses
    WHERE 1=1
    <if test="list != null and list.size > 0">
      AND student_id IN
      <foreach item="id" collection="list" open="(" separator="," close=")">
        #{id}
      </foreach>
    </if>
    <if test="list == null or list.size == 0">
      AND 1=0  </if>
  </select>
<!--  status by student id-->
  <select id="searchStatusByStudentId" resultType="raisetech.student.management.data.ApplicationStatus">
    SELECT a.* FROM application_status a
    INNER JOIN student_courses c ON a.course_id = c.id
    WHERE 1=1
    <if test="list != null and list.size > 0">
      AND c.student_id IN
      <foreach item="id" collection="list" open="(" separator="," close=")">
        #{id}
      </foreach>
    </if>
    <if test="list == null or list.size == 0">
      AND 1=0  </if>
  </select>
<!--  register new application status-->
  <insert id="registerStatus" parameterType="raisetech.student.management.data.ApplicationStatus"
    useGeneratedKeys ="true" keyProperty = "id">
    INSERT INTO application_status (course_id, application_status)
    VALUES (#{courseId}, #{applicationStatus})
  </insert>
<!--  update application status-->
  <update id="updateStatus" parameterType="raisetech.student.management.data.ApplicationStatus">
    UPDATE application_status
    SET
      application_status = #{applicationStatus}
    WHERE id = #{id}
  </update>
<!--  select student by criteria-->
  <select id="searchStudentByCriteria" resultType="raisetech.student.management.data.Student">
    SELECT DISTINCT
    s.id,
    s.name,
    s.kana_name,
    s.nickname,
    s.email_address,
    s.residence,
    s.age,
    s.gender,
    s.remark,
    s.was_deleted
    FROM students s
    INNER JOIN student_courses c ON s.id = c.student_id
    INNER JOIN application_status a ON c.id = a.course_id
    <where>
      <if test="name != null and name != ''">
        AND s.name LIKE CONCAT('%', #{name}, '%')
      </if>
      <if test="emailAddress != null and emailAddress != ''">
        AND s.email_address LIKE CONCAT('%', #{emailAddress}, '%')
      </if>
      <if test="gender != null and gender != ''">
        AND s.gender LIKE CONCAT('%', #{gender}, '%')
      </if>
      <if test="courseName != null and courseName != ''">
        AND c.course_name LIKE CONCAT('%', #{courseName}, '%')
      </if>
      <if test="applicationStatus != null and applicationStatus != ''">
        AND a.application_status LIKE CONCAT('%', #{applicationStatus}, '%')
      </if>
    </where>
    
  </select>


</mapper>